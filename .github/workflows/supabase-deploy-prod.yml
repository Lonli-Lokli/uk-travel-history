name: Supabase Deploy (production)

on:
  push:
    branches: [master]
    paths:
      - 'supabase/**'
      - '.github/workflows/supabase-deploy-prod.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even without migration changes'
        required: false
        default: 'false'

jobs:
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Authenticate Supabase CLI
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "ERROR: SUPABASE_ACCESS_TOKEN secret is not set"
            exit 1
          fi
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Link to production project
        env:
          SUPABASE_PROJECT_REF_PROD: ${{ secrets.SUPABASE_PROJECT_REF_PROD }}
          SUPABASE_DB_PASSWORD_PROD: ${{ secrets.SUPABASE_DB_PASSWORD_PROD }}
        run: |
          if [ -z "$SUPABASE_PROJECT_REF_PROD" ]; then
            echo "ERROR: SUPABASE_PROJECT_REF_PROD secret is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_DB_PASSWORD_PROD" ]; then
            echo "ERROR: SUPABASE_DB_PASSWORD_PROD secret is not set"
            exit 1
          fi
          supabase link --project-ref "$SUPABASE_PROJECT_REF_PROD" --password "$SUPABASE_DB_PASSWORD_PROD"

      - name: Push migrations to production
        run: |
          echo "Applying migrations to production database..."
          supabase db push --linked

      - name: Drift check (migrations vs remote)
        run: |
          echo "Checking for schema drift..."
          supabase db diff --linked --schema public > drift.sql

          if [ -s drift.sql ]; then
            echo "ERROR: Production schema drift detected"
            echo "The remote database differs from the migrations in GitHub."
            echo "This indicates manual changes were made via Dashboard or other means."
            echo ""
            echo "Drift details:"
            cat drift.sql
            echo ""
            echo "To resolve:"
            echo "1. Run 'supabase db pull' locally to capture remote changes"
            echo "2. Commit the generated migration"
            echo "3. Add a postmortem note explaining the drift"
            exit 1
          else
            echo "No drift detected - production matches GitHub migrations âœ“"
          fi

      - name: Upload drift report (if detected)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: schema-drift-report
          path: drift.sql
          retention-days: 30
