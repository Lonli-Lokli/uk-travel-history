name: Supabase Preview (staging)

on:
  pull_request:
    branches: [ master ]
    types: [opened, synchronize, reopened]
    paths:
      - 'supabase/**'
      - '.github/workflows/supabase-preview-branch.yml'

permissions:
  contents: read

jobs:
  preview-branch:
    runs-on: ubuntu-latest

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD_STAGING: ${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}
      SUPABASE_PROJECT_REF_STAGING: ${{ secrets.SUPABASE_PROJECT_REF_STAGING }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Authenticate Supabase CLI
        run: supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Link CLI to staging project
        shell: bash
        run: |
          set -euo pipefail
          
          if [ -z "$SUPABASE_PROJECT_REF_STAGING" ]; then
            echo "ERROR: SUPABASE_PROJECT_REF_STAGING secret is not set"
            exit 1
          fi
          
          if [ -z "$SUPABASE_DB_PASSWORD_STAGING" ]; then
            echo "ERROR: SUPABASE_DB_PASSWORD_STAGING secret is not set"
            exit 1
          fi
          
          echo "Linking to staging project..."
          supabase link --project-ref "$SUPABASE_PROJECT_REF_STAGING" --password "$SUPABASE_DB_PASSWORD_STAGING"

      - name: Apply PR migrations to staging
        shell: bash
        run: |
          set -euo pipefail
          echo "Applying migrations to staging database..."
          supabase db push --linked
          
      - name: Comment PR with staging link
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Migrations applied to staging database for testing.'
            })
